<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>yysaki blog - Terraform RegistryのModuleを使ってHasuraを立てる</title>
    <link rel="alternate" type="application/atom+xml" href="/atom" title="yysaki blog">
    <script src="/main.js" />
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-48038483-1', 'auto');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <header class="interior-header green">
      <div class="row">
        <div class="medium-12 medium-centered centered-text columns">
          <h1>
            <a class="centered-text light" href="/">yysaki blog</a>
          </h1>
          <nav>
            <ul class="subnav hide-for-small">
              <li><a href="/">Home</a></li>
              <li class="with-input">
                <form action="https://google.com/search" method="get">
                  <input type="hidden" name="cx" value="004581985367838202738:guvugwiuerc"/>
                  <input class="input-text" type="text" name="q" placeholder="Search"/>
                </form>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </header>

    <div class="row">
      <div class="large-8 medium-7 columns">
        <main role="main">
        <div class="date">2020-06-07</div>
<h1>Terraform RegistryのModuleを使ってHasuraを立てる</h1>

<p>Terraformの素振りのため、公開されているModuleを使ってAWS ECSクラスター上にHasuraを立ててみました.<br />
Auth0での認証認可まで疎通確認できたので手順を共有します.</p>

<h2 id="概要">概要</h2>

<p><a href="https://hasura.io/">Hasura</a> について軽く説明をすると, これはPostgreSQLをバックエンドとしてAPIを自動生成してくれるGraphQLサーバーです. DBスキーマからとりうるCRUD操作をAPI越しに一通り行うことができるようにしてくれます. また、ロールベースの権限付与の仕組みをサポートしており、 <a href="https://auth0.com/jp/">Auth0</a> といったOAuthサービスプロバイダーと組み合わせることで、Hasura外部のサービスで認証を行ったユーザの認可から, ロールに許されたAPI操作を割り振ることができます。<br />
Hasuraのサービスを稼働させるためにはHerokuが推奨されていますが、あえてAWSで立てようとするなら <a href="https://hub.docker.com/r/hasura/graphql-engine">docker hubに提供されているDockerイメージ</a> とデータストアであるPostgreSQLを構築する必要から、ECSを使うのが自然な選択肢になるかと思います. ちょうどTerraformでAWSの環境構築をする練習りをしたかったこともあり <a href="https://hasura.io/">Hasura</a>を立てるのがお題として手頃そうでした.<br />
一方、Terraform Registryを”hasura”で検索してみると3件ほどマッチしました。 このうちメンテナンスされておりdownload数の多い <a href="https://registry.terraform.io/modules/Rayraegah/hasura/aws/3.0.2">Rayraegah/hasura/aws</a> があります.  ライセンスのところに <a href="https://github.com/elgordino">Gordon Johnston</a> により提案されたAWSアーキテクチャを採用しているとあります, おそらく以下の記事のことと見られます.</p>

<p><a href="https://dev.to/lineup-ninja/deploying-hasura-on-aws-with-fargate-rds-and-terraform-4gk7">Deploying Hasura on AWS with Fargate, RDS and Terraform - DEV</a></p>

<p>今回はこちらをお借りしてTerraformを素振りさせてもらいました.</p>

<h2 id="事前準備">事前準備</h2>

<p>今回の手順を行うにあたって必要な準備は以下の通りです:</p>

<ul>
  <li>Terraform 0.12 の実行環境</li>
  <li>AWSアカウント
    <ul>
      <li>IAMユーザ</li>
      <li>Route53で管理されているドメイン</li>
    </ul>
  </li>
  <li>Auth0アカウント</li>
  <li><a href="https://www.electronjs.org/apps/graphiql">GraphiQL.app</a> の実行環境
    <ul>
      <li>macos Homebrewであれば <code>brew cask install graphiql</code> しておく</li>
    </ul>
  </li>
</ul>

<p>この記事ではそれぞれのセットアップについては述べません.</p>

<h2 id="auth0の設定">Auth0の設定</h2>

<p>まず, Auth0について <a href="https://hasura.io/docs/1.0/graphql/manual/guides/integrations/auth0-jwt.html">Hasuraの公式ドキュメント</a> を参考に事前にSingle Page Applicationを用意しておきます. Hasuraの認証認可の仕組みをこちらで整えることになります.  手順の通りなのですが, ハマりどころとして2点補足しておきます.</p>

<p>一つ目はRulesです. “Configure Auth0 Rules &amp; Callback URLs”の手順にてJWTカスタムクレームを埋め込むためのスニペットが2通り記載されています. 厳密にはどちらでも構いませんが, この手順では前者のauth0.js向けのスニペットを入力してください. 2つ目は <a href="https://auth0.com/docs/api-auth/tutorials/adoption/oidc-conformant">OIDC Conformantを無効にする</a> ということです. “Test auth0 login and generate sample JWTs for testing” の手順でid_tokenを取得しますが, これを無効にしておかないとコールバック時にエラーとなります.</p>

<h2 id="terraformのapply">TerraformのApply</h2>

<p>手元の実行環境のお好きなディレクトリ配下に, Terraformのapplyのためmoduleの呼び出しを行う <code>main.tf</code> および変数定義を行う <code>terraform.tfvars</code> を用意しました.<br />
<a href="https://gist.github.com/yysaki/ad8396547b9fc1f14865d1b554bd24b7">gist</a>に貼ってありますが、それぞれ以下の通りです:</p>

<p>まず, main.tf:</p>

<div class="language-terraform highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre>variable &quot;domain&quot; {}
variable &quot;hasura_admin_secret&quot; {}
variable &quot;rds_password&quot; {}
variable &quot;hasura_jwt_secret_key&quot; {}

module &quot;hasura&quot; {
  source                         = &quot;Rayraegah/hasura/aws&quot;
  version                        = &quot;3.0.2&quot;
  domain                         = var.domain
  hasura_version_tag             = &quot;v1.2.1&quot;
  hasura_admin_secret            = var.hasura_admin_secret
  hasura_jwt_secret_key          = var.hasura_jwt_secret_key
  hasura_jwt_secret_algo         = &quot;RS256&quot;
  rds_db_name                    = &quot;hasura&quot;
  rds_instance                   = &quot;db.t3.small&quot;
  rds_username                   = &quot;hasura&quot;
  rds_password                   = var.rds_password
  create_iam_service_linked_role = false
}

provider &quot;aws&quot; {
  region = &quot;ap-northeast-1&quot;
}
</pre></div>
</div>
</div>

<p>module “hasura”になるべくdefault値を使ったうえで必要な変数定義をしています. 秘密情報にしたかったものはvariableに切り出してtfvarsにて記述することにしました. defaultを上書きした変数は3箇所あります. 1つ目は <code>hasura_version_tag</code> , これは単純に執筆時点の最新版を使いたかったためです. 2つ目は <code>hasura_jwt_secret_algo</code> , こちらにはHS256 または RS256が選べますが, Auth0で使用するのは後者のため設定しました. 最後にcreate_iam_service_linked_role, これはAWSのアカウント上で初めてECSを作成したときに勝手に作られる <a href="https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/developerguide/using-service-linked-roles.html">service_linked_role</a> の有無についてです. 私の環境では以前にECSクラスターを作ったことがあるためfalseにしましたが, この操作が初めての場合defaultのtrueとしておきましょう.</p>

<p>次に, terraform.tfvars:</p>

<div class="language-txt highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre>domain                = &quot;example.com&quot;
hasura_admin_secret   = &quot;Password&quot;
rds_password          = &quot;Password&quot;
hasura_jwt_secret_key = &lt;&lt;EOF
-----BEGIN CERTIFICATE-----
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxx
-----END CERTIFICATE-----
EOF
</pre></div>
</div>
</div>

<p>これにはvariableで定義した変数を指定しています. 1つ目の <code>domain</code> にはRoute53で管理しているdomainを指定してください. 続く <code>hasura_admin_secret</code> <code>rds_password</code> には, 前者はHasura管理画面の、 後者はRDSのパスワードになります. 最後の <code>hasura_jwt_secret_key</code> には先のAuth0の設定後に得られる公開鍵情報を入力します. <code>https://&lt;your-auth0-domain&gt;.auth0.com/pem</code> にアクセスすることで取得できます.</p>

<p>以上で設定が完了です. 作業したディレクトリ上で <code>terraform init</code>, <code>terraform plan</code>, <code>terraform apply</code> を実行しましょう.</p>

<h2 id="hasuraコンソールにログインする">Hasuraコンソールにログインする</h2>

<p>上記が無事成功したことを確認するために, ブラウザから <code>https://hasura.&lt;あなたのdomain&gt;</code> にアクセスしましょう. Hasuraのパスワード入力画面が出ますので, <code>hasura_admin_secret</code> を入力してください. <br />
Hasuraの管理画面が開くはずです.</p>

<p>Hasuraのコンソール画面から, テーブル定義およびそれのuserへのpermissionをしたとします. コンソール上でポチポチ操作するだけでOKで, これによりDBマイグレーションなどのメタデータ設定が簡単に行えます. 私の環境では <code>users</code> と <code>posts</code> テーブルを一対多の関係で定義、<code>user</code> ロールにそれぞれのテーブルへのSELECT権限の付与を行いました.</p>

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">hasuraが立ったので雑なテーブル定義 <a href="https://t.co/jiOcOHCasZ">pic.twitter.com/jiOcOHCasZ</a></p>&mdash; sasaki (@yysaki) <a href="https://twitter.com/yysaki/status/1264112622816735232?ref_src=twsrc%5Etfw">May 23, 2020</a></blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<h2 id="graphql-apiの操作">GraphQL APIの操作</h2>

<p>これまでの設定がうまくいったことを確認するために, GraphQL APIを触ってみたいと思います. 手順としてはGraphiQL.app を起動します. アプリが起動したら <code>GraphQL Endpoint</code>に <code>https://hasura.&lt;あなたのdomain&gt;/v1/graphql</code> を入力します. 次に <code>Edit HTTP Headers</code> をクリックし, <code>Add Header</code> からHeader nameに<code>Authorization</code>, Header valueに <code>Bearer &lt;id_token&gt;</code> を入力します. このid_tokenは “Test auth0 login and generate sample JWTs for testing”で取得したものになります. これでトップ画面に戻るとうまくいった場合Document Explorer &gt; ROOT TYPES に利用可能なqueryがリストアップされます. これでHasuraから認証認可を踏まえたGraphQLのndpointが得られました.</p>

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">Auth0認可も通ったのでOK <a href="https://t.co/6TaN17mIqU">pic.twitter.com/6TaN17mIqU</a></p>&mdash; sasaki (@yysaki) <a href="https://twitter.com/yysaki/status/1264122926783066112?ref_src=twsrc%5Etfw">May 23, 2020</a></blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<h2 id="後始末">後始末</h2>

<p>満足できるまで確認ができたら, 課金対象ですので AWSリソース を削除しましょう.  ただし, 安全のためaws_db_instanceのlife_cycleが <code>prevent_destroy = true</code> となっているため, 単に<code>terraform destroy</code> をしても成功しません. workaroundとして, main.tf 中のmodule定義をすべてコメントアウトして <code>terraform apply</code> を行ってから <code>terraform destroy</code> をすることでリソースの削除に成功します.</p>

<h2 id="まとめ">まとめ</h2>

<p>以上で, terraformのmoduleを使わせてもらったAWSでのhasuraの構築の素振りを行いました. 素振りをやろうとした当初はイチからtfファイルを書く気持ちでいたのですが, 先人の肩を借りて手数少なく実施することができました. まじまじとregistryに公開されているmoduleを読むのは初めてでしたが, ためになります.</p>


        </main>
      </div>

      <div class="large-4 medium-5 columns">
        <aside class="sidebar">
          <div class="about">
            <h1>About Me</h1>
            <ul class="side-nav">
              <li role="menuitem"><a href="https://twitter.com/yysaki">@yysaki on Twitter</a></li>
              <li role="menuitem"><a href="https://github.com/yysaki">@yysaki on Github</a></li>
            </ul>
          </div>

          

<div class="recent">
  <h1>Recent Posts</h1>
  <ul class="side-nav">
    
      <li role="menuitem"><a href="/blog/2020/06/07/terraform-hasura/">Terraform RegistryのModuleを使ってHasuraを立てる</a></li>
    
      <li role="menuitem"><a href="/blog/2020/04/29/react-tic-tac-toe/">Reactのチュートリアルで三目並べ</a></li>
    
      <li role="menuitem"><a href="/blog/2019/04/14/techbookfest-6/">技術書典6に参加した</a></li>
    
      <li role="menuitem"><a href="/blog/2019/01/02/happy-new-year/">昨年の振り返りと新年の抱負</a></li>
    
      <li role="menuitem"><a href="/blog/2018/09/30/vue-firebase-tutorial/">#Webサービスを作る本 を読んで簡易markdownエディタを作った</a></li>
    
  </ul>
</div>


          <div class="twitter">
            <h1>Timeline</h1>
            <a class="twitter-timeline" data-lang="ja" data-width="271" data-height="600" href="https://twitter.com/yysaki?ref_src=twsrc%5Etfw">Tweets by yysaki</a> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
          </div>
        </aside>
      </div>
    </div>
  </body>
</html>
